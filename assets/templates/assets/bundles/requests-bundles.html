{% load i18n %}
{% load humanize %}
{% load static %}

{% comment %}
<script type="application/javascript" src="{% static 'assets/js/requests.js' %}"></script>
{% endcomment %}

<script>
/* global assetsSettings, moment, bootstrap */
var manage_requests = assetsSettings.manage_requests;

var csrfToken = assetsSettings.csrfToken;
var urlRequests, urlMyRequests;

document.addEventListener('DOMContentLoaded', function () {
    urlRequests = '/assets/api/requests/';
    urlMyRequests = '/assets/api/requests/myrequests/';
    // Initialisieren Sie die DataTable für assets
    var requests = initializeRequests('#requests', urlRequests);
    var myrequests = initializeRequests('#my-requests', urlMyRequests);
});

function initializeRequests(tableId, url) {
    return $(tableId).DataTable({
        'ajax': {
            'url': url,
            'dataSrc': function(json) {
                // Store the data in a global variable
                return json;
            }
        },
        'columns': [
            {
                data: 'id',
                render: function(data, type, row) {
                    return data;
                }
            },
            {
                data: 'order',
                render: function(data, type, row) {
                    return data;
                }
            },
            {
                data: 'requestor',
                render: function(data, type, row) {
                    return data;
                }
            },
            {
                data: 'status',
                render: function(data, type, row) {
                    return data;
                }
            },
            {
                data: 'created',
                render: function(data, type, row) {
                    return moment(data).format('L LT');
                }
            },
            {
                data: 'actions',
                className: 'text-end',
                render: function(data, type, row) {
                    return data
                }
            },
        ],
        order: [[3, 'desc']],
        pageLength: 25,
        autoWidth: false,
        columnDefs: [
            { 'sortable': false, 'targets': [1, 5] },
        ],
    });
}
</script>

<script>
/* global assetsSettings */

document.addEventListener('DOMContentLoaded', function () {
    const RequestStatistics = $.ajax({
        url: assetsSettings.statisticsUrl, // URL für die Statistikdaten
        type: 'GET',
        dataType: 'json',
        success: function (data) {
            // Erfolgreiche Antwort: Aktualisiere den Inhalt des request-count-Elements
            const requestCountElement = document.getElementById('request-count');
            const myRequestCountElement = document.getElementById('my-request-count');
            
            if (requestCountElement) {
                const requestCount = data.requestCount || 0;
                if (requestCount > 0) {
                    requestCountElement.textContent = requestCount; // Setze den Wert
                    requestCountElement.classList.remove('d-none'); // Entferne die Klasse 'd-none', um das Element sichtbar zu machen
                }
            }
            
            if (myRequestCountElement) {
                const myRequestCount = data.myRequestCount || 0;
                if (myRequestCount > 0) {
                    myRequestCountElement.textContent = myRequestCount; // Setze den Wert
                    myRequestCountElement.classList.remove('d-none'); // Entferne die Klasse 'd-none', um das Element sichtbar zu machen
                }
            }
        },
        error: function (xhr, status, error) {
            console.error('Fehler beim Abrufen der Statistikdaten:', error);
        }
    });
})
</script>